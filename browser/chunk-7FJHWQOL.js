import{j as D,p as J}from"./chunk-I4ERTK6J.js";import{A as v,B as $,C as T,E,G as A,L as a,N as P,P as U,Q as N,S as O,U as S,Xb as g,Z as F,_ as c,a as l,b as f,d as h,da as C,g as k,j as I,k as B,la as x,m as d,o as _,s as m,ua as b}from"./chunk-OYHVDZPP.js";function y(n){n||(C(y),n=c(x));let i=new k(e=>n.onDestroy(e.next.bind(e)));return e=>e.pipe(N(i))}function M(n,i){let e=!i?.manualCleanup;e&&!i?.injector&&C(M);let r=e?i?.injector?.get(x)??c(x):null,t=V(i?.equal),s;i?.requireSync?s=b({kind:0},{equal:t}):s=b({kind:1,value:i?.initialValue},{equal:t});let u=n.subscribe({next:o=>s.set({kind:1,value:o}),error:o=>{if(i?.rejectErrors)throw o;s.set({kind:2,error:o})}});if(i?.requireSync&&s().kind===0)throw new O(601,!1);return r?.onDestroy(u.unsubscribe.bind(u)),g(()=>{let o=s();switch(o.kind){case 1:return o.value;case 2:throw o.error;case 0:throw new O(601,!1)}},{equal:i?.equal})}function V(n=Object.is){return(i,e)=>i.kind===1&&e.kind===1&&n(i.value,e.value)}var p={query:w,get:G,post:K,put:W,remove:Y,makeId:L};function w(n,i=100){return h(this,null,function*(){var e=JSON.parse(localStorage.getItem(n)||"null")||[];return i?new Promise(r=>setTimeout(r,i,e)):e})}function G(n,i){return h(this,null,function*(){let r=(yield w(n)).find(t=>t._id===i);if(!r)throw new Error(`Cannot get, Item ${i} of type: ${n} does not exist`);return r})}function K(n,i){return h(this,null,function*(){i=f(l({},i),{_id:L()});let e=yield w(n);return e.push(i),R(n,e),i})}function W(n,i){return h(this,null,function*(){let e=yield w(n),r=e.findIndex(t=>t._id===i._id);return e[r]=i,R(n,e),i})}function Y(n,i){return h(this,null,function*(){let e=yield w(n),r=e.findIndex(t=>t._id===i);if(r!==-1)e.splice(r,1);else throw new Error(`Cannot remove, item ${i} of type: ${n} does not exist`);R(n,e)})}function R(n,i){localStorage.setItem(n,JSON.stringify(i))}function L(n=5){for(var i="",e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",r=0;r<n;r++)i+=e.charAt(Math.floor(Math.random()*e.length));return i}var j="pets",H=(()=>{class n{constructor(){this.http=c(D)}getPets(e){return d(p.query(j)).pipe(m(r=>this._filterPets(r,e)),a(1))}removePet(e){return d(p.remove(j,e)).pipe(a(1))}addPet(e){return d(p.post(j,e)).pipe(a(1))}updatePet(e){return d(p.put(j,e)).pipe(a(1))}savePet(e){return(e._id?this.updatePet(e):this.addPet(e)).pipe(m(r=>({pet:r,isAdded:!e._id})),a(1))}_filterPets(e,r){return e.filter(t=>t.name.toLowerCase().includes(r.term.toLowerCase()))}static{this.\u0275fac=function(r){return new(r||n)}}static{this.\u0275prov=S({token:n,factory:n.\u0275fac,providedIn:"root"})}}return n})();var q="pets",Me=(()=>{class n{constructor(e){this.http=e,this.apiService=c(H),this.router=c(J),this._filterBy$=new B({term:""}),this._removePet$=new I,this._savePet$=new I,this.filterBy_=M(this._filterBy$,{requireSync:!0}),this.pets_=b(null),this.errors_=b({fetch:null,save:null,remove:null}),this.fetchError_=g(()=>this.errors_().fetch),this.saveError_=g(()=>this.errors_().save),this.removeError_=g(()=>this.errors_().remove),this.filteredPets$=this._filterBy$.pipe(T(500),A((t,s)=>t===s,t=>t.term),U(t=>this.apiService.getPets(t)),v(t=>this._handleError(t,"fetch")),P()),this.removedPetId$=this._removePet$.pipe($(t=>this.apiService.removePet(t).pipe(m(()=>t))),v(t=>this._handleError(t,"remove")),P()),this.savedPet$=this._savePet$.pipe($(t=>this.apiService.savePet(t)),v(t=>this._handleError(t,"save")),P());let r=JSON.parse(localStorage.getItem(q)||"null");(!r||r.length===0)&&localStorage.setItem(q,JSON.stringify(this._createPets())),this.filteredPets$.pipe(y()).subscribe({next:t=>{this.pets_.set(t)},error:t=>{console.log({err:t})}}),this.removedPetId$.pipe(y()).subscribe({next:t=>{this.pets_.update(s=>s.filter(u=>u._id!==t))},error:t=>(console.log({err:t}),_(()=>t))}),this.savedPet$.pipe(y()).subscribe({next:({pet:t,isAdded:s})=>{this.pets_.update(u=>s?[...u,t]:u.map(o=>o._id===t._id?t:o))},error:t=>{console.log({err:t})}})}shouldAdoptPet(){return this.http.get("https://yesno.wtf/api").pipe(m(e=>e.answer),a(1),v(e=>_(()=>e)))}getEmptyPet(){return{name:"",age:0,birthDate:Date.now()}}remove(e){return this._removePet$.next(e),this.removedPetId$.pipe(E(1))}save(e){return this._savePet$.next(e),this.savedPet$.pipe(E(1))}setFilterBy(e){this._filterBy$.next(l({},e))}getById(e){return d(p.get(q,e)).pipe(a(1),v(r=>this._handleError(r)))}cleanErrors(e){this.errors_.update(r=>{if(e)return f(l({},r),{[e]:null});for(let t in r)r[t]=null;return r})}_createPets(){return[{_id:"p123",name:"Penrose",age:2,birthDate:new Date("2020-11-12").getTime()},{_id:"p124",name:"Bobo",age:6,birthDate:new Date("2021-8-30").getTime()},{_id:"p125",name:"Gertrude",age:1,birthDate:new Date("2021-11-1").getTime()},{_id:"p126",name:"Popovich",age:62,birthDate:new Date("1950-3-30").getTime()}]}_handleError(e,r){return console.log({err:e,type:r}),r&&this.errors_.update(t=>f(l({},t),{[r]:this._isString(e)?e:e.message})),_(()=>e)}_isString(e){return typeof e=="string"||e instanceof String}static{this.\u0275fac=function(r){return new(r||n)(F(D))}}static{this.\u0275prov=S({token:n,factory:n.\u0275fac,providedIn:"root"})}}return n})();export{y as a,M as b,Me as c};
